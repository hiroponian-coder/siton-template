name: Update Deployed URL

# site-{uuid} ブランチへの push をトリガーに
# Vercel のデプロイが完了したら vending-frontend の DB に URL を保存する
on:
  push:
    branches:
      - 'site-*'

jobs:
  update-url:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Wait for Vercel deployment and update URL
        env:
          VERCEL_ACCESS_TOKEN: ${{ secrets.VERCEL_ACCESS_TOKEN }}
          VERCEL_SCOPE: ${{ secrets.VERCEL_SCOPE }}
          VERCEL_REPO_NAME: ${{ secrets.VERCEL_REPO_NAME }}
          INTERNAL_API_SECRET: ${{ secrets.INTERNAL_API_SECRET }}
          APP_URL: ${{ secrets.APP_URL }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "Branch: $BRANCH_NAME"
          echo "Polling Vercel for deployment completion..."

          MAX_ATTEMPTS=60   # 10秒×60回 = 最大10分
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -sf \
              "https://api.vercel.com/v6/deployments?projectId=${VERCEL_REPO_NAME}&teamId=${VERCEL_SCOPE}&limit=20" \
              -H "Authorization: Bearer ${VERCEL_ACCESS_TOKEN}" \
              2>/dev/null) || true

            if [ -z "$RESPONSE" ]; then
              echo "Vercel API call failed, retrying..."
              sleep 10
              continue
            fi

            # ブランチ名に一致する READY な deployment を探す
            RESULT=$(echo "$RESPONSE" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    deps = data.get('deployments', [])
    branch = '${BRANCH_NAME}'
    for dep in deps:
        if dep.get('meta', {}).get('githubCommitRef') == branch:
            state = dep.get('state', '')
            url = dep.get('url', '')
            print(f'{state}|{url}')
            break
    else:
        print('NOT_FOUND|')
except Exception as e:
    print(f'ERROR|{e}')
" 2>/dev/null || echo "PARSE_ERROR|")

            STATE=$(echo "$RESULT" | cut -d'|' -f1)
            URL=$(echo "$RESULT" | cut -d'|' -f2)

            echo "  State: $STATE, URL: $URL"

            if [ "$STATE" = "READY" ] && [ -n "$URL" ]; then
              echo "Deployment ready! Updating DB..."

              curl -sf -X POST "${APP_URL}/api/update-deployed-url" \
                -H "Content-Type: application/json" \
                -H "x-internal-secret: ${INTERNAL_API_SECRET}" \
                -d "{\"branch_name\": \"${BRANCH_NAME}\", \"deployed_url\": \"https://${URL}\"}" \
              && echo "DB updated successfully!" \
              || echo "WARNING: DB update call failed"

              exit 0
            fi

            if [ "$STATE" = "ERROR" ] || [ "$STATE" = "CANCELED" ]; then
              echo "Deployment ended with state: $STATE. Exiting."
              exit 0
            fi

            sleep 10
          done

          echo "Timeout reached without READY state."
          exit 0
